---
title: Registry - Scheduled tasks (Taskcache)
summary: 'Scheduled tasks are used to automatically perform a task on the system whenever the criteria associated to the scheduled task occurs.\n\nA scheduled task can be created through direct manipulation of the registry in order to avoid the generation of task creation ETW events.\n\nInformation of interest, for each task under its associated "Taskcache\Tasks\<TASK_GUID>" and "Taskcache\Tree\<TASK_NAME>" subkeys: task name and file path, lifecycle timestamps (created on, last start, and last
    stop), and trigger(s) and action(s).\n\nThe lifecycle timestamps, trigger(s), and action(s) are in binary, non human readable format.'
keywords:
tags:
  - windows_local_persistence
  - windows_lateral_movement
  - windows_lateral_movement_dst
  - windows_registry
location: 'File: <SYSTEMROOT>\System32\config\SOFTWARE\n\nRegistry keys:\nHKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\Taskcache\Tasks\<TASK_GUID>\nHKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\Taskcache\Tree\<TASK_NAME>'
last_updated: 2024-01-09
sidebar: sidebar
permalink: windows_registry_scheduled_tasks.html
folder: windows
---

### Overview

Scheduled tasks are used to automatically perform a task on the system whenever
the criteria associated to the scheduled task occurs. The scheduled tasks can
either be run at a defined time, on repeat at set intervals, or when a specific
event occurs, such as the system boot.

The following registry keys are created upon the creation of a new scheduled
task:
  - `Schedule\Taskcache\Tasks\<TASK_GUID>`.
  - `Schedule\Taskcache\Tree\<TASK_NAME>`.

A scheduled task can be created through direct manipulation of the
registry only, as implemented in
[GhostTask](https://github.com/netero1010/GhostTask) for instance. [Creating a
scheduled task this way will not generate task creation ETW events](https://labs.withsecure.com/publications/scheduled-task-tampering).
However, the task will not be functional until the `Schedule` service is
restarted or task configuration modified, to a reload by the `Schedule`
service. Modifying the task would generate associated ETW events (channel
`Microsoft-Windows-TaskScheduler/Operational`, event 140 or `Security`, non
default event 4702).

Additionally, a scheduled task can continue to run even if its associated
elements in the registry and / or on disk (`XML` files) are deleted. The
scheduled task will be fully hidden but will persist until the system is
rebooted or the `svchost.exe` process associated with that task is terminated.
The `ETW` events generated by the task execution will however still be
generated.

### Information of interest

Each scheduled task configuration is defined in a dedicated subkey under
`Schedule\Taskcache\Tasks`, identified by the task GUID (i.e.
`Schedule\Taskcache\Tasks\<TASK_GUID>`).

For each tasks, the following notable information is available under the task
GUID root key `Schedule\Taskcache\Tasks\<TASK_GUID>`:

  - The task path.

  - Some lifecycle timestamps of the task: created on, last start, and last
    stop in the `DynamicInfo` value (in binary format).

  - The task trigger(s) (`Triggers` value) and action(s) (`Actions` value) in
    binary, non human readable format.

  - The task security descriptor (in `SDDL` notation), in the
    `SecurityDescriptor` value.

The mapping between a task name and its GUID can be done using the subkeys of
the `Schedule\Taskcache\Tree` keys. Indeed, each task is referenced by its name
as a subkey of the `Schedule\Taskcache\Tree` key (i.e.
`Schedule\Taskcache\Tree\<TASK_NAME>`), with the GUID of the task
stored in the `Id` value.

Additionally, the `Schedule\Taskcache\Tree\<TASK_NAME>` hold the
`Security Descriptor` of the scheduled task (in the `SD` value). Removing this
value will hide the scheduled task, from utilities such as `schtasks` or the
`Task Scheduler`, while leaving it functional. This was implemented in the
[Tarrask malware, as discovered by Micosoft](https://www.microsoft.com/en-us/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/).

### References

  - [Microsoft - Tarrask malware uses scheduled tasks for defense evasion](https://www.microsoft.com/en-us/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/)

  - [WithSecure - Riccardo Ancarani - Scheduled Task Tampering](https://labs.withsecure.com/publications/scheduled-task-tampering)

  - [cyber.wtf - Luca Ebach - Windows Registry Analysis – Today’s Episode: Tasks](https://cyber.wtf/2022/06/01/windows-registry-analysis-todays-episode-tasks/)
